<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Zenith Playground</title>

<link rel="stylesheet" href="ui.css">
</head>

<body>

<h1>Zenith Playground</h1>

<textarea id="input" placeholder='
/zen
/lang "en"

/head
  /charset
  /page "Zenith Demo"
/head/

/header
  /title "Hello World" serif:bold:#ccc:center
/header/
'></textarea>

<div class="controls">
  <button onclick="compileZenith()">Compile</button>
  <button onclick="previewZenith()">Preview</button>
</div>

<h2>HTML Output</h2>
<pre id="htmlOut"></pre>

<h2>CSS Output</h2>
<pre id="cssOut"></pre>

<div id="warnings"></div>

<div id="preview">
  <button onclick="closePreview()">Close Preview</button>
  <iframe id="frame"></iframe>
</div>

<script>
/* ========= DICTIONARY ========= */
const DICTIONARY = {
  zen: { type: "doctype" },
  lang: { type: "html-attr" },

  head: { type: "block", tag: "head" },
  charset: { type: "meta", output: '<meta charset="UTF-8">' },
  page: { type: "meta", tag: "title" },

  header: { type: "block", tag: "header" },
  main: { type: "block", tag: "main" },
  footer: { type: "block", tag: "footer" },

  title: { type: "text", tag: "h1" },
  text: { type: "text", tag: "p" }
};

/* ========= COMPILER ========= */
function compileZenith() {
  const lines = document.getElementById("input").value.split("\n");

  let body = [];
  let css = [];
  let warnings = [];
  let stack = [];

  let lang = "en";
  let pageTitle = "Zenith Page";

  const open = tag => {
    body.push("  ".repeat(stack.length) + `<${tag}>`);
    stack.push(tag);
  };

  const close = tag => {
    if (stack.pop() !== tag) {
      warnings.push(`Mismatched close: ${tag}`);
    }
    body.push("  ".repeat(stack.length) + `</${tag}>`);
  };

  for (let raw of lines) {
    let line = raw.trim();
    if (!line) continue;

    if (line === "/zen") continue;

    if (line.startsWith("/lang")) {
      lang = line.match(/"(.+?)"/)?.[1] || lang;
      continue;
    }

    if (line === "/head") { open("head"); continue; }
    if (line === "/head/") { close("head"); continue; }

    if (line === "/header") { open("header"); continue; }
    if (line === "/header/") { close("header"); continue; }

    if (line === "/main") { open("main"); continue; }
    if (line === "/main/") { close("main"); continue; }

    if (line === "/charset") {
      body.push("  ".repeat(stack.length) + `<meta charset="UTF-8">`);
      continue;
    }

    if (line.startsWith("/page")) {
      pageTitle = line.match(/"(.+?)"/)?.[1] || pageTitle;
      continue;
    }

    if (line.startsWith("/title")) {
      const match = line.match(/"(.+?)"\s*(.*)/);
      const text = match?.[1] || "";
      const style = match?.[2] || "";

      body.push("  ".repeat(stack.length) + `<h1>${text}</h1>`);

      if (style) {
        const p = style.split(":");
        let rules = [];
        if (p[0]) rules.push(`font-family:${p[0]}`);
        if (p[1]) rules.push(`font-weight:${p[1]}`);
        if (p[2]) rules.push(`color:${p[2]}`);
        if (p[3]) rules.push(`text-align:${p[3] === "centre" ? "center" : p[3]}`);
        css.push(`h1 { ${rules.join("; ")}; }`);
      }
      continue;
    }

    warnings.push("Unknown line: " + line);
  }

  const html =
`<!DOCTYPE html>
<html lang="${lang}">
<head>
  <meta charset="UTF-8">
  <title>${pageTitle}</title>
</head>
<body>
${body.join("\n")}
</body>
</html>`;

  document.getElementById("htmlOut").textContent = html;
  document.getElementById("cssOut").textContent = css.join("\n");
  document.getElementById("warnings").textContent = warnings.join("\n");
}

/* ========= PREVIEW ========= */
function previewZenith() {
  const html = document.getElementById("htmlOut").textContent;
  const css = document.getElementById("cssOut").textContent;

  const bodyOnly = html
    .replace(/^[\s\S]*?<body>/, "")
    .replace(/<\/body>[\s\S]*$/, "");

  document.getElementById("frame").srcdoc = `
<!DOCTYPE html>
<html>
<head>
<style>${css}</style>
</head>
<body>
${bodyOnly}
</body>
</html>`;

  document.getElementById("preview").style.display = "block";
}

function closePreview() {
  document.getElementById("preview").style.display = "none";
}
</script>

</body>
</html>